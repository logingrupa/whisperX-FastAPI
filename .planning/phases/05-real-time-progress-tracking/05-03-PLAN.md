---
phase: 05-real-time-progress-tracking
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - frontend/src/components/upload/StageBadge.tsx
  - frontend/src/components/upload/FileProgress.tsx
  - frontend/src/components/upload/ConnectionStatus.tsx
  - frontend/src/components/upload/FileQueueItem.tsx
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees progress bar with percentage for active files"
    - "User sees stage badge with step counter (1/5, 2/5) and tooltip"
    - "User sees subtle reconnecting indicator during connection loss"
    - "User sees visible warning and Reconnect button after 5 failed attempts"
    - "User sees toast notification and inline error for failed files"
    - "User can click Retry button to re-attempt processing"
    - "Completed files show checkmark icon, not 100% progress bar"
  artifacts:
    - path: "frontend/src/components/upload/StageBadge.tsx"
      provides: "Stage indicator badge with colors and step counter"
      exports: ["StageBadge"]
    - path: "frontend/src/components/upload/FileProgress.tsx"
      provides: "Progress bar with percentage and spinner"
      exports: ["FileProgress"]
    - path: "frontend/src/components/upload/ConnectionStatus.tsx"
      provides: "Connection status indicator with reconnect button"
      exports: ["ConnectionStatus"]
    - path: "frontend/src/components/upload/FileQueueItem.tsx"
      provides: "Updated file item with progress display"
      contains: "FileProgress"
  key_links:
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/components/upload/FileProgress.tsx"
      via: "Import and render for uploading/processing files"
      pattern: "import.*FileProgress"
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/components/upload/StageBadge.tsx"
      via: "Import and render for stage display"
      pattern: "import.*StageBadge"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/upload/ConnectionStatus.tsx"
      via: "Import and render for connection indicator"
      pattern: "import.*ConnectionStatus"
---

<objective>
Create progress UI components and integrate into file queue display

Purpose: Show real-time progress to users with stage badges, progress bars, and error handling
Output: StageBadge, FileProgress, ConnectionStatus components; updated FileQueueItem with progress display
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-progress-tracking/05-CONTEXT.md
@.planning/phases/05-real-time-progress-tracking/05-RESEARCH.md
@.planning/phases/05-real-time-progress-tracking/05-01-SUMMARY.md
@.planning/phases/05-real-time-progress-tracking/05-02-SUMMARY.md

# Existing components to modify
@frontend/src/components/upload/FileQueueItem.tsx
@frontend/src/App.tsx

# Progress configuration and types
@frontend/src/lib/progressStages.ts
@frontend/src/types/websocket.ts
@frontend/src/types/upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StageBadge and FileProgress components</name>
  <files>
    - frontend/src/components/upload/StageBadge.tsx
    - frontend/src/components/upload/FileProgress.tsx
  </files>
  <action>
    1. Create `frontend/src/components/upload/StageBadge.tsx`:
       ```typescript
       import { Badge } from '@/components/ui/badge';
       import {
         Tooltip,
         TooltipContent,
         TooltipTrigger,
       } from '@/components/ui/tooltip';
       import { cn } from '@/lib/utils';
       import {
         FRIENDLY_STAGE_NAMES,
         STAGE_COLORS,
         STAGE_STEPS,
         TOTAL_STEPS,
         getStageTooltip,
       } from '@/lib/progressStages';
       import type { ProgressStage } from '@/types/websocket';

       interface StageBadgeProps {
         stage: ProgressStage | 'error';
         className?: string;
       }

       /**
        * Stage indicator badge showing current processing stage
        *
        * Per CONTEXT.md:
        * - Badge/chip showing current stage name
        * - Step counter in badge (1/5, 2/5, etc.)
        * - Tooltip reveals remaining stages
        * - Different badge color per stage (Upload=blue, Processing=yellow, Complete=green, Error=red)
        */
       export function StageBadge({ stage, className }: StageBadgeProps) {
         const isError = stage === 'error';
         const label = isError ? 'Error' : FRIENDLY_STAGE_NAMES[stage];
         const color = STAGE_COLORS[stage];
         const step = isError ? 0 : STAGE_STEPS[stage];

         // Show step counter for processing stages (not for error, complete, or uploading)
         const showStepCounter =
           !isError && stage !== 'complete' && stage !== 'uploading' && step > 0;

         return (
           <Tooltip>
             <TooltipTrigger asChild>
               <Badge
                 className={cn('border-transparent cursor-help', color, className)}
               >
                 {label}
                 {showStepCounter && ` (${step}/${TOTAL_STEPS})`}
               </Badge>
             </TooltipTrigger>
             <TooltipContent>
               <p>{getStageTooltip()}</p>
             </TooltipContent>
           </Tooltip>
         );
       }
       ```

    2. Create `frontend/src/components/upload/FileProgress.tsx`:
       ```typescript
       import { Loader2 } from 'lucide-react';
       import { Progress } from '@/components/ui/progress';

       interface FileProgressProps {
         /** Progress percentage 0-100 */
         percentage: number;
         /** Show spinner alongside progress */
         showSpinner?: boolean;
         className?: string;
       }

       /**
        * Progress bar with percentage and optional spinner
        *
        * Per CONTEXT.md:
        * - Progress bar with percentage (horizontal bar, percentage text alongside)
        * - Smooth animation between percentage updates (via CSS)
        * - Spinner icon alongside progress bar during active processing
        */
       export function FileProgress({
         percentage,
         showSpinner = true,
         className,
       }: FileProgressProps) {
         return (
           <div className={cn('flex items-center gap-2', className)}>
             {showSpinner && (
               <Loader2 className="h-4 w-4 animate-spin text-muted-foreground shrink-0" />
             )}
             <Progress value={percentage} className="flex-1 h-2" />
             <span className="text-sm text-muted-foreground w-10 text-right shrink-0">
               {percentage}%
             </span>
           </div>
         );
       }

       // Helper import
       import { cn } from '@/lib/utils';
       ```

       Actually, fix the import order:
       ```typescript
       import { Loader2 } from 'lucide-react';
       import { Progress } from '@/components/ui/progress';
       import { cn } from '@/lib/utils';

       interface FileProgressProps {
         /** Progress percentage 0-100 */
         percentage: number;
         /** Show spinner alongside progress */
         showSpinner?: boolean;
         className?: string;
       }

       /**
        * Progress bar with percentage and optional spinner
        *
        * Per CONTEXT.md:
        * - Progress bar with percentage (horizontal bar, percentage text alongside)
        * - Smooth animation between percentage updates (via CSS)
        * - Spinner icon alongside progress bar during active processing
        */
       export function FileProgress({
         percentage,
         showSpinner = true,
         className,
       }: FileProgressProps) {
         return (
           <div className={cn('flex items-center gap-2', className)}>
             {showSpinner && (
               <Loader2 className="h-4 w-4 animate-spin text-muted-foreground shrink-0" />
             )}
             <Progress value={percentage} className="flex-1 h-2" />
             <span className="text-sm text-muted-foreground w-10 text-right shrink-0">
               {percentage}%
             </span>
           </div>
         );
       }
       ```

    3. Verify build passes: `bun run build`
  </action>
  <verify>
    - `bun run build` completes without errors
    - StageBadge.tsx exports StageBadge component
    - FileProgress.tsx exports FileProgress component
  </verify>
  <done>
    StageBadge component with colors and step counter tooltip, FileProgress component with progress bar and spinner
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConnectionStatus indicator component</name>
  <files>frontend/src/components/upload/ConnectionStatus.tsx</files>
  <action>
    Create `frontend/src/components/upload/ConnectionStatus.tsx`:

    ```typescript
    import { Loader2, WifiOff } from 'lucide-react';
    import { Button } from '@/components/ui/button';
    import type { ConnectionState } from '@/hooks/useTaskProgress';

    interface ConnectionStatusProps {
      connectionState: ConnectionState;
      onReconnect: () => void;
    }

    /**
     * Connection status indicator showing WebSocket state
     *
     * Per CONTEXT.md:
     * - Subtle "Reconnecting..." indicator during connection loss, auto-reconnect in background
     * - After 5 failed attempts (~30 seconds), escalate to visible warning
     * - Show manual "Reconnect" button after max attempts
     */
    export function ConnectionStatus({
      connectionState,
      onReconnect,
    }: ConnectionStatusProps) {
      const { isConnected, isReconnecting, maxAttemptsReached, reconnectAttempt } =
        connectionState;

      // Don't show anything when connected
      if (isConnected) {
        return null;
      }

      // Subtle indicator during reconnection attempts (first 5 attempts)
      if (isReconnecting && !maxAttemptsReached) {
        return (
          <div className="flex items-center gap-2 text-muted-foreground text-sm py-2">
            <Loader2 className="h-4 w-4 animate-spin" />
            <span>Reconnecting... (attempt {reconnectAttempt}/{5})</span>
          </div>
        );
      }

      // Escalated warning after max attempts reached
      if (maxAttemptsReached) {
        return (
          <div className="flex items-center gap-2 bg-amber-100 text-amber-800 px-3 py-2 rounded-md">
            <WifiOff className="h-4 w-4 shrink-0" />
            <span className="flex-1">Connection lost. Progress updates may be missed.</span>
            <Button
              variant="outline"
              size="sm"
              onClick={onReconnect}
              className="shrink-0"
            >
              Reconnect
            </Button>
          </div>
        );
      }

      // Not connected but not yet trying to reconnect (initial connection)
      return null;
    }
    ```

    Verify build passes: `bun run build`
  </action>
  <verify>
    - `bun run build` completes without errors
    - ConnectionStatus.tsx exports ConnectionStatus component
    - Component handles isConnected, isReconnecting, maxAttemptsReached states
  </verify>
  <done>
    ConnectionStatus component with subtle reconnecting indicator and escalated warning with Reconnect button
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate progress display into FileQueueItem</name>
  <files>frontend/src/components/upload/FileQueueItem.tsx</files>
  <action>
    Update `frontend/src/components/upload/FileQueueItem.tsx` to show progress:

    1. Add new imports at top:
       ```typescript
       import { X, Play, AlertCircle, CheckCircle2, RotateCcw } from 'lucide-react';
       import { StageBadge } from './StageBadge';
       import { FileProgress } from './FileProgress';
       ```

    2. Update interface to add onRetry prop:
       ```typescript
       interface FileQueueItemProps {
         item: FileQueueItemType;
         onRemove: (id: string) => void;
         onUpdateSettings: (
           id: string,
           updates: { selectedLanguage?: LanguageCode | ''; selectedModel?: WhisperModel }
         ) => void;
         onStart?: (id: string) => void;
         onRetry?: (id: string) => void;
         onShowErrorDetails?: (errorMessage: string, technicalDetail?: string) => void;
       }
       ```

    3. Update the component to show different states. Replace the entire component body with:
       ```typescript
       export function FileQueueItem({
         item,
         onRemove,
         onUpdateSettings,
         onStart,
         onRetry,
         onShowErrorDetails,
       }: FileQueueItemProps) {
         const isPending = item.status === 'pending';
         const isProcessing = item.status === 'uploading' || item.status === 'processing';
         const isComplete = item.status === 'complete';
         const isError = item.status === 'error';
         const isReady = isPending && item.selectedLanguage !== '';

         return (
           <Card className={cn(
             'transition-colors',
             isError && 'border-destructive',
             isComplete && 'border-green-500',
           )}>
             <CardContent className="p-4">
               <div className="flex flex-col gap-3">
                 {/* Top row: File info and actions */}
                 <div className="flex items-center gap-4">
                   {/* Status icon for complete/error */}
                   {isComplete && (
                     <CheckCircle2 className="h-5 w-5 text-green-500 shrink-0" />
                   )}
                   {isError && (
                     <AlertCircle className="h-5 w-5 text-destructive shrink-0" />
                   )}

                   {/* File info */}
                   <div className="flex-1 min-w-0">
                     <div className="flex items-center gap-2">
                       <p className="font-medium truncate" title={item.file.name}>
                         {item.file.name}
                       </p>
                       {/* Detected language badge (only when pending) */}
                       {item.detectedLanguage && isPending && (
                         <Tooltip>
                           <TooltipTrigger asChild>
                             <Badge variant="secondary" className="shrink-0">
                               {getLanguageName(item.detectedLanguage)}
                             </Badge>
                           </TooltipTrigger>
                           <TooltipContent>
                             <p>Detected from filename pattern</p>
                           </TooltipContent>
                         </Tooltip>
                       )}
                       {/* Stage badge (when processing) */}
                       {isProcessing && item.progressStage && (
                         <StageBadge stage={item.progressStage} />
                       )}
                       {/* Complete badge */}
                       {isComplete && (
                         <StageBadge stage="complete" />
                       )}
                       {/* Error badge */}
                       {isError && (
                         <StageBadge stage="error" />
                       )}
                       {/* Warning if no language selected (pending only) */}
                       {!item.selectedLanguage && isPending && (
                         <Tooltip>
                           <TooltipTrigger asChild>
                             <AlertCircle className="h-4 w-4 text-amber-500 shrink-0" />
                           </TooltipTrigger>
                           <TooltipContent>
                             <p>Please select a language</p>
                           </TooltipContent>
                         </Tooltip>
                       )}
                     </div>
                     <p className="text-sm text-muted-foreground">
                       {formatFileSize(item.file.size)}
                       {/* Error message with "Show details" link */}
                       {isError && item.errorMessage && (
                         <>
                           <span className="ml-2">- {item.errorMessage}</span>
                           {item.technicalDetail && onShowErrorDetails && (
                             <button
                               type="button"
                               className="ml-2 text-primary hover:underline"
                               onClick={() =>
                                 onShowErrorDetails(item.errorMessage!, item.technicalDetail)
                               }
                             >
                               Show details
                             </button>
                           )}
                         </>
                       )}
                     </p>
                   </div>

                   {/* Settings (only when pending) */}
                   {isPending && (
                     <>
                       <LanguageSelect
                         value={item.selectedLanguage}
                         onValueChange={(value) =>
                           onUpdateSettings(item.id, { selectedLanguage: value })
                         }
                       />
                       <ModelSelect
                         value={item.selectedModel}
                         onValueChange={(value) =>
                           onUpdateSettings(item.id, { selectedModel: value })
                         }
                       />
                     </>
                   )}

                   {/* Actions */}
                   <div className="flex items-center gap-2">
                     {/* Start button (per-file, pending only) */}
                     {onStart && isPending && (
                       <Button
                         variant="outline"
                         size="sm"
                         onClick={() => onStart(item.id)}
                         disabled={!isReady}
                         title={isReady ? 'Start processing' : 'Select language first'}
                       >
                         <Play className="h-4 w-4" />
                       </Button>
                     )}

                     {/* Retry button (error only) */}
                     {onRetry && isError && (
                       <Button
                         variant="outline"
                         size="sm"
                         onClick={() => onRetry(item.id)}
                         title="Retry processing"
                       >
                         <RotateCcw className="h-4 w-4" />
                       </Button>
                     )}

                     {/* Remove button (only when pending) */}
                     {isPending && (
                       <Button
                         variant="ghost"
                         size="sm"
                         onClick={() => onRemove(item.id)}
                         className="text-muted-foreground hover:text-destructive"
                       >
                         <X className="h-4 w-4" />
                       </Button>
                     )}
                   </div>
                 </div>

                 {/* Progress bar row (when uploading or processing) */}
                 {isProcessing && item.progressPercentage !== undefined && (
                   <FileProgress
                     percentage={item.progressPercentage}
                     showSpinner={true}
                   />
                 )}
               </div>
             </CardContent>
           </Card>
         );
       }
       ```

    4. Verify build passes: `bun run build`
  </action>
  <verify>
    - `bun run build` completes without errors
    - FileQueueItem shows progress bar for uploading/processing status
    - FileQueueItem shows stage badge with step counter
    - FileQueueItem shows checkmark icon for complete status
    - FileQueueItem shows error badge and retry button for error status
    - FileQueueItem shows "Show details" link for errors with technical detail
  </verify>
  <done>
    FileQueueItem updated to show progress bar, stage badge, complete/error icons, retry button, and error details link
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Real-time progress tracking UI components:
    - StageBadge: Shows current processing stage with color-coded badge and step counter (1/5, 2/5, etc.)
    - FileProgress: Progress bar with percentage and spinner
    - ConnectionStatus: Subtle reconnecting indicator, escalated warning after 5 attempts
    - Updated FileQueueItem: Shows progress for active files, checkmark for complete, error state with retry button

    Note: This verifies the UI COMPONENTS are built. Actual WebSocket connection to backend and file upload/processing flow will be wired in Phase 6 when the upload API is integrated. For now, you can verify the components render correctly in different states.
  </what-built>
  <how-to-verify>
    1. Start dev server: `bun run dev` from frontend/ directory
    2. Open http://localhost:5173/ui in browser
    3. Verify the upload page loads without errors

    To test component states, you can temporarily modify the queue state in App.tsx or useFileQueue to add test items with different statuses. The actual end-to-end flow with real WebSocket updates will be tested when upload API integration is complete in Phase 6.

    Check for:
    - Build passes without TypeScript errors
    - Components are importable (no missing exports)
    - No console errors on page load
    - Existing upload functionality (drag-drop, file picker) still works
  </how-to-verify>
  <resume-signal>Type "approved" if components build correctly and existing functionality preserved, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `bun run build` passes without errors
2. All new components export correctly
3. FileQueueItem renders different states (pending, processing, complete, error)
4. StageBadge shows correct colors per stage
5. FileProgress shows smooth animated progress bar
6. ConnectionStatus shows appropriate indicators for connection state
7. Existing upload functionality (drag-drop, file picker, queue management) still works
</verification>

<success_criteria>
- StageBadge shows stage name, step counter (1/5), and tooltip with all stages
- StageBadge uses correct colors (blue for upload/queued, yellow for processing, green for complete, red for error)
- FileProgress shows progress bar with percentage and spinner
- ConnectionStatus shows subtle "Reconnecting..." during attempts, escalated warning after 5 failures
- FileQueueItem shows progress bar and stage badge for uploading/processing files
- FileQueueItem shows checkmark icon for completed files (not 100% progress bar)
- FileQueueItem shows error state with retry button and "Show details" link
- Existing functionality preserved (drag-drop, file picker, language/model selection)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-progress-tracking/05-03-SUMMARY.md`
</output>
