---
phase: 07-backend-chunk-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/tus_upload_api.py
  - app/main.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "POST to /uploads/files/ returns 201 with Location header containing upload URL"
    - "PATCH to upload URL accepts binary chunk data and returns Upload-Offset"
    - "HEAD to upload URL returns current Upload-Offset for resume"
    - "OPTIONS to /uploads/files/ returns TUS headers (Tus-Resumable, Tus-Version, Tus-Extension)"
    - "Existing /speech-to-text endpoint continues working unchanged"
    - "TUS-specific headers are exposed in CORS configuration"
  artifacts:
    - path: "app/api/tus_upload_api.py"
      provides: "TUS protocol router using tuspyserver"
      contains: "create_tus_router"
    - path: "app/main.py"
      provides: "TUS router mount and CORS with TUS headers"
      contains: "tus_upload_router"
  key_links:
    - from: "app/api/tus_upload_api.py"
      to: "tuspyserver"
      via: "create_tus_router import"
      pattern: "from tuspyserver import create_tus_router"
    - from: "app/main.py"
      to: "app/api/tus_upload_api.py"
      via: "router include"
      pattern: "include_router.*tus_upload_router"
---

<objective>
Install tuspyserver and create the TUS protocol router mounted at /uploads/, with CORS headers exposed for TUS operations.

Purpose: This is the foundation for chunked uploads. Without the TUS router accepting POST/PATCH/HEAD requests per the TUS protocol, no chunks can be received.
Output: A working TUS endpoint at /uploads/files/ that accepts upload creation and chunk data, storing to disk.
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-chunk-infrastructure/07-RESEARCH.md
@app/main.py
@app/core/upload_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create TUS router module</name>
  <files>
    requirements.txt
    app/api/tus_upload_api.py
  </files>
  <action>
    1. Install tuspyserver and apscheduler:
       Run `pip install tuspyserver==4.2.3 apscheduler==3.10.4`
       Add both to requirements.txt (check if requirements.txt exists, might be pyproject.toml - find the correct dependency file and add there).

    2. Create `app/api/tus_upload_api.py`:
       - Import `create_tus_router` from `tuspyserver`
       - Import `UPLOAD_DIR` from `app.core.upload_config`
       - Define `TUS_UPLOAD_DIR = UPLOAD_DIR / "tus"` for TUS-specific storage
       - Create the TUS router using `create_tus_router()` with these settings:
         - `prefix="files"` (will be nested under /uploads/ prefix)
         - `files_dir=str(TUS_UPLOAD_DIR)` (disk storage, not memory)
         - `max_size=5 * 1024 * 1024 * 1024` (5GB max, matches upload_config.py MAX_FILE_SIZE)
         - `days_to_keep=1` (built-in expiry, backup for scheduler cleanup)
         - `upload_complete_dep=None` for now (Plan 02 wires the real hook)
       - Create a wrapper APIRouter with `prefix="/uploads"` and `tags=["TUS Upload"]`
       - Include the tus_router in the wrapper router
       - Export `tus_upload_router` for use in main.py
       - Ensure `TUS_UPLOAD_DIR` is also exported (Plan 03 needs it for cleanup)

    Follow existing conventions:
    - Module docstring at top
    - Google-style docstrings
    - Type hints on everything
    - Use absolute imports from app.*
    - snake_case for variables, PascalCase for classes
  </action>
  <verify>
    Run `python -c "from app.api.tus_upload_api import tus_upload_router, TUS_UPLOAD_DIR; print('OK')"` succeeds.
    Run `pip show tuspyserver` shows version 4.2.3.
  </verify>
  <done>
    tus_upload_router is importable and configured with correct settings. tuspyserver is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount TUS router in main.py and configure CORS for TUS headers</name>
  <files>
    app/main.py
  </files>
  <action>
    1. Add CORS middleware with TUS headers BEFORE router registration (CORS must be added before routers):
       - Define TUS_HEADERS list containing: "Location", "Upload-Offset", "Upload-Length", "Tus-Resumable", "Tus-Version", "Tus-Extension", "Tus-Max-Size", "Upload-Expires"
       - Check if CORSMiddleware is already added to the app. If yes, update the existing middleware to include `expose_headers=TUS_HEADERS`. If no, add new CORSMiddleware with `allow_origins=["*"]`, `allow_methods=["*"]`, `allow_headers=["*"]`, `expose_headers=TUS_HEADERS`.
       - Place the middleware addition AFTER app creation but BEFORE router includes.

    2. Import and include the TUS upload router:
       - Add `from app.api.tus_upload_api import tus_upload_router`
       - Add `app.include_router(tus_upload_router)` alongside existing router includes
       - Place it BEFORE `setup_spa_routes(app)` (SPA catch-all must remain last)

    3. Ensure TUS upload directory is created on startup:
       - In the lifespan function, add `TUS_UPLOAD_DIR.mkdir(parents=True, exist_ok=True)` at startup
       - Import TUS_UPLOAD_DIR from app.api.tus_upload_api

    4. Do NOT modify any existing router registrations or endpoints. The /speech-to-text endpoint must continue working unchanged.

    5. Add "TUS Upload" to tags_metadata list for OpenAPI docs.
  </action>
  <verify>
    1. Run the app: `cd C:/laragon/www/whisperx && python -c "from app.main import app; print([r.path for r in app.routes if 'upload' in str(r.path).lower()])"` shows /uploads/files routes.
    2. Verify existing routes still present: `python -c "from app.main import app; routes = [r.path for r in app.routes]; assert '/speech-to-text' in routes, f'Missing speech-to-text in {routes}'; print('Existing routes OK')"`.
    3. Start server briefly and test TUS OPTIONS: `curl -s -X OPTIONS http://localhost:8000/uploads/files/ -H "Tus-Resumable: 1.0.0" -I` should return Tus-Version header.
  </verify>
  <done>
    TUS router is mounted at /uploads/files/. CORS exposes TUS headers. Existing /speech-to-text endpoint is unaffected. TUS upload directory is created on startup.
  </done>
</task>

</tasks>

<verification>
1. `pip show tuspyserver` returns version 4.2.3
2. `python -c "from app.main import app; print('app loads')"` succeeds without errors
3. Start the server and verify:
   - POST /uploads/files/ with Upload-Length header returns 201 with Location header
   - GET /speech-to-text (existing) still returns expected response
   - OPTIONS /uploads/files/ returns TUS protocol headers
4. CORS headers include TUS-specific headers in response
</verification>

<success_criteria>
- tuspyserver installed and importable
- TUS router mounted at /uploads/files/
- POST creates upload session, PATCH accepts chunks, HEAD returns offset
- CORS middleware exposes all TUS headers
- Existing /speech-to-text endpoint unchanged
- TUS files stored in UPLOAD_DIR/tus/ on disk
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-chunk-infrastructure/07-01-SUMMARY.md`
</output>
