---
phase: 07-backend-chunk-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/infrastructure/scheduler/__init__.py
  - app/infrastructure/scheduler/cleanup_scheduler.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "Incomplete upload sessions are cleaned up automatically every 10 minutes"
    - "Cleanup runs on a background schedule without blocking the application"
    - "Scheduler starts on application startup and stops on shutdown"
    - "Cleanup logs how many expired sessions were removed"
    - "Cleanup also runs once on startup to clear any stale sessions from previous runs"
  artifacts:
    - path: "app/infrastructure/scheduler/__init__.py"
      provides: "Scheduler package init"
    - path: "app/infrastructure/scheduler/cleanup_scheduler.py"
      provides: "APScheduler-based cleanup for expired TUS upload sessions"
      contains: "cleanup_expired_uploads"
    - path: "app/main.py"
      provides: "Lifespan hooks for scheduler start/stop"
      contains: "start_cleanup_scheduler"
  key_links:
    - from: "app/infrastructure/scheduler/cleanup_scheduler.py"
      to: "tuspyserver"
      via: "remove_expired_files import"
      pattern: "remove_expired_files"
    - from: "app/main.py"
      to: "app/infrastructure/scheduler/cleanup_scheduler.py"
      via: "lifespan start/stop calls"
      pattern: "start_cleanup_scheduler|stop_cleanup_scheduler"
---

<objective>
Create a background scheduler that cleans up expired TUS upload sessions every 10 minutes, integrated into FastAPI's lifespan.

Purpose: Without cleanup, incomplete uploads from abandoned sessions fill up disk. The 10-minute expiry ensures stale sessions are removed promptly (per BACK-06 requirement).
Output: APScheduler-based cleanup job running in the background, started/stopped with the app.
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-chunk-infrastructure/07-RESEARCH.md
@.planning/phases/07-backend-chunk-infrastructure/07-01-SUMMARY.md
@app/main.py
@app/core/upload_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cleanup scheduler module</name>
  <files>
    app/infrastructure/scheduler/__init__.py
    app/infrastructure/scheduler/cleanup_scheduler.py
  </files>
  <action>
    1. Create `app/infrastructure/scheduler/__init__.py`:
       - Module docstring: "Background scheduling infrastructure."
       - Export `start_cleanup_scheduler` and `stop_cleanup_scheduler` from cleanup_scheduler module.

    2. Create `app/infrastructure/scheduler/cleanup_scheduler.py`:
       - Import `AsyncIOScheduler` from `apscheduler.schedulers.asyncio`
       - Import `remove_expired_files` from `tuspyserver` (this is the built-in cleanup function)
       - Import `logger` from `app.core.logging`
       - Import `TUS_UPLOAD_DIR` from `app.api.tus_upload_api`

       Define module-level constants:
       - `CLEANUP_INTERVAL_MINUTES = 10` (per BACK-06: 10 minute cleanup interval)

       Create module-level scheduler instance:
       - `scheduler = AsyncIOScheduler()`

       Create `cleanup_expired_uploads()` function:
       - Call `remove_expired_files(str(TUS_UPLOAD_DIR))`
       - Log at INFO level how many files were cleaned (if any)
       - Wrap in try/except, log errors at ERROR level but never crash
       - This is a sync function (APScheduler handles the async scheduling)

       Create `start_cleanup_scheduler()` function:
       - Add the cleanup job with `scheduler.add_job()`:
         - func: `cleanup_expired_uploads`
         - trigger: `"interval"`
         - minutes: `CLEANUP_INTERVAL_MINUTES`
         - id: `"cleanup_expired_uploads"`
         - replace_existing: `True`
       - Run cleanup once immediately on startup: `cleanup_expired_uploads()`
       - Start the scheduler: `scheduler.start()`
       - Log at INFO: "Started upload cleanup scheduler (interval: {CLEANUP_INTERVAL_MINUTES} min)"

       Create `stop_cleanup_scheduler()` function:
       - Call `scheduler.shutdown(wait=False)`
       - Log at INFO: "Stopped upload cleanup scheduler"

    Follow conventions: module docstrings, Google-style docstrings, type hints, absolute imports, snake_case.
  </action>
  <verify>
    Run `python -c "from app.infrastructure.scheduler import start_cleanup_scheduler, stop_cleanup_scheduler; print('OK')"` succeeds.
    Run `python -c "from app.infrastructure.scheduler.cleanup_scheduler import cleanup_expired_uploads, CLEANUP_INTERVAL_MINUTES; assert CLEANUP_INTERVAL_MINUTES == 10; print('OK')"` succeeds.
  </verify>
  <done>
    Cleanup scheduler module exists with start/stop functions and 10-minute interval cleanup job. Immediate cleanup on startup included.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate scheduler into FastAPI lifespan</name>
  <files>
    app/main.py
  </files>
  <action>
    Update `app/main.py` to start/stop the cleanup scheduler in the lifespan context manager:

    1. Add import at the top (with existing noqa pattern):
       `from app.infrastructure.scheduler import start_cleanup_scheduler, stop_cleanup_scheduler  # noqa: E402`

    2. In the `lifespan()` async context manager:
       - BEFORE `yield`: add `start_cleanup_scheduler()` after existing startup code (after `set_main_loop`, `save_openapi_json`, `generate_db_schema`)
       - AFTER `yield`: add `stop_cleanup_scheduler()` before the existing "Shutting down" log message

    3. Do NOT modify any other part of main.py. The TUS router include was already added by Plan 01.

    The lifespan should look like:
    ```
    async def lifespan(app):
        set_main_loop(asyncio.get_running_loop())
        logging.info("Application lifespan started...")
        save_openapi_json(app)
        generate_db_schema(...)
        start_cleanup_scheduler()  # NEW
        yield
        stop_cleanup_scheduler()   # NEW
        logging.info("Shutting down application")
    ```
  </action>
  <verify>
    1. Run `python -c "from app.main import app; print('app loads with scheduler')"` succeeds without errors.
    2. Verify lifespan includes scheduler: `python -c "import inspect; from app.main import lifespan; src = inspect.getsource(lifespan); assert 'start_cleanup_scheduler' in src; assert 'stop_cleanup_scheduler' in src; print('Lifespan hooks OK')"`.
  </verify>
  <done>
    Cleanup scheduler starts on app startup and stops on shutdown. Expired TUS sessions are cleaned every 10 minutes. Immediate cleanup runs on startup.
  </done>
</task>

</tasks>

<verification>
1. Scheduler module imports cleanly
2. Scheduler starts without errors when app starts
3. Cleanup function handles missing directory gracefully (first run before any uploads)
4. Scheduler stops cleanly on app shutdown
5. No interference with existing app functionality
6. 10-minute interval matches BACK-06 requirement
</verification>

<success_criteria>
- APScheduler runs cleanup_expired_uploads every 10 minutes
- Startup cleanup clears stale sessions from previous runs
- Scheduler integrated into FastAPI lifespan (start on startup, stop on shutdown)
- Errors in cleanup are logged but never crash the app
- BACK-06 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-chunk-infrastructure/07-03-SUMMARY.md`
</output>
