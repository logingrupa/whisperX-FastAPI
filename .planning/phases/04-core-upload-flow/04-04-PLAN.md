---
phase: 04-core-upload-flow
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - frontend/src/components/upload/FileQueueItem.tsx
  - frontend/src/components/upload/FileQueueList.tsx
  - frontend/src/components/upload/LanguageSelect.tsx
  - frontend/src/components/upload/ModelSelect.tsx
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees file queue with filename, size, and settings"
    - "User sees detected language badge with tooltip"
    - "User can select language from grouped dropdown"
    - "User can select Whisper model from dropdown"
    - "User can remove individual pending files"
    - "User can clear all pending files"
    - "Start buttons disabled until language selected"
  artifacts:
    - path: "frontend/src/components/upload/FileQueueItem.tsx"
      provides: "Individual file display with settings"
      exports: ["FileQueueItem"]
      min_lines: 80
    - path: "frontend/src/components/upload/FileQueueList.tsx"
      provides: "Queue list with actions"
      exports: ["FileQueueList"]
      min_lines: 40
    - path: "frontend/src/components/upload/LanguageSelect.tsx"
      provides: "Grouped language dropdown"
      exports: ["LanguageSelect"]
      min_lines: 40
    - path: "frontend/src/components/upload/ModelSelect.tsx"
      provides: "Whisper model dropdown"
      exports: ["ModelSelect"]
      min_lines: 30
    - path: "frontend/src/App.tsx"
      provides: "Assembled upload page"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/components/upload/LanguageSelect.tsx"
      via: "renders LanguageSelect component"
      pattern: "<LanguageSelect"
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/components/upload/ModelSelect.tsx"
      via: "renders ModelSelect component"
      pattern: "<ModelSelect"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/upload/UploadDropzone.tsx"
      via: "renders UploadDropzone"
      pattern: "<UploadDropzone"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/hooks/useFileQueue.ts"
      via: "useFileQueue hook"
      pattern: "useFileQueue\\(\\)"
---

<objective>
Create file queue display components, language/model selection dropdowns, and assemble the complete upload page.

Purpose: Completes the upload UI by adding the queue item display (with detected language badge, settings dropdowns, remove button), queue list with "Clear all" and "Start all" actions, and wiring everything together in App.tsx.
Output: Fully functional upload page where users can add files, configure settings per file, and prepare for processing.
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-upload-flow/04-CONTEXT.md
@.planning/phases/04-core-upload-flow/04-RESEARCH.md
@frontend/src/types/upload.ts
@frontend/src/lib/languages.ts
@frontend/src/lib/whisperModels.ts
@frontend/src/hooks/useFileQueue.ts
@frontend/src/components/upload/UploadDropzone.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LanguageSelect and ModelSelect components</name>
  <files>
    frontend/src/components/upload/LanguageSelect.tsx
    frontend/src/components/upload/ModelSelect.tsx
  </files>
  <action>
Create frontend/src/components/upload/LanguageSelect.tsx:

```typescript
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { CORE_LANGUAGES, OTHER_LANGUAGES } from '@/lib/languages';
import type { LanguageCode } from '@/types/upload';

interface LanguageSelectProps {
  value: LanguageCode | '';
  onValueChange: (value: LanguageCode) => void;
  disabled?: boolean;
}

/**
 * Language selection dropdown with grouped options
 *
 * Groups:
 * - Primary: Core 3 languages (Latvian, Russian, English) pinned at top
 * - Other: Additional common languages
 *
 * Per CONTEXT.md: "Core 3 languages pinned at top of dropdown"
 */
export function LanguageSelect({
  value,
  onValueChange,
  disabled = false,
}: LanguageSelectProps) {
  return (
    <Select
      value={value}
      onValueChange={onValueChange as (value: string) => void}
      disabled={disabled}
    >
      <SelectTrigger className="w-[140px]">
        <SelectValue placeholder="Select language" />
      </SelectTrigger>
      <SelectContent>
        <SelectGroup>
          <SelectLabel>Primary</SelectLabel>
          {CORE_LANGUAGES.map(language => (
            <SelectItem key={language.code} value={language.code}>
              {language.name}
            </SelectItem>
          ))}
        </SelectGroup>
        <SelectGroup>
          <SelectLabel>Other</SelectLabel>
          {OTHER_LANGUAGES.map(language => (
            <SelectItem key={language.code} value={language.code}>
              {language.name}
            </SelectItem>
          ))}
        </SelectGroup>
      </SelectContent>
    </Select>
  );
}
```

Create frontend/src/components/upload/ModelSelect.tsx:

```typescript
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { WHISPER_MODELS } from '@/lib/whisperModels';
import type { WhisperModel } from '@/types/upload';

interface ModelSelectProps {
  value: WhisperModel;
  onValueChange: (value: WhisperModel) => void;
  disabled?: boolean;
}

/**
 * Whisper model selection dropdown
 *
 * Shows all available model sizes with their labels
 * Default: large-v3 (per user preference for accuracy)
 */
export function ModelSelect({
  value,
  onValueChange,
  disabled = false,
}: ModelSelectProps) {
  return (
    <Select
      value={value}
      onValueChange={onValueChange as (value: string) => void}
      disabled={disabled}
    >
      <SelectTrigger className="w-[130px]">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {WHISPER_MODELS.map(model => (
          <SelectItem key={model.value} value={model.value}>
            {model.label}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```
  </action>
  <verify>
    - `cat frontend/src/components/upload/LanguageSelect.tsx` shows grouped select
    - `cat frontend/src/components/upload/ModelSelect.tsx` shows model select
    - `grep "CORE_LANGUAGES" frontend/src/components/upload/LanguageSelect.tsx` confirms import
    - `grep "WHISPER_MODELS" frontend/src/components/upload/ModelSelect.tsx` confirms import
  </verify>
  <done>
    - LanguageSelect renders grouped dropdown with Primary/Other sections
    - ModelSelect renders all Whisper model options
    - Both accept value, onValueChange, disabled props
    - Proper TypeScript types used
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileQueueItem and FileQueueList components</name>
  <files>
    frontend/src/components/upload/FileQueueItem.tsx
    frontend/src/components/upload/FileQueueList.tsx
  </files>
  <action>
Create frontend/src/components/upload/FileQueueItem.tsx:

```typescript
import { X, Play, AlertCircle } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { LanguageSelect } from './LanguageSelect';
import { ModelSelect } from './ModelSelect';
import { getLanguageName } from '@/lib/languages';
import type { FileQueueItem as FileQueueItemType, LanguageCode, WhisperModel } from '@/types/upload';
import { cn } from '@/lib/utils';

interface FileQueueItemProps {
  item: FileQueueItemType;
  onRemove: (id: string) => void;
  onUpdateSettings: (
    id: string,
    updates: { selectedLanguage?: LanguageCode | ''; selectedModel?: WhisperModel }
  ) => void;
  onStart?: (id: string) => void;
}

/**
 * Format file size for display
 */
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
}

/**
 * Individual file in the upload queue
 *
 * Displays:
 * - Filename and size
 * - Detected language badge (with tooltip explaining detection)
 * - Language selection dropdown
 * - Model selection dropdown
 * - Remove button (only when pending)
 * - Start button (only when pending and language selected)
 */
export function FileQueueItem({
  item,
  onRemove,
  onUpdateSettings,
  onStart,
}: FileQueueItemProps) {
  const isPending = item.status === 'pending';
  const isReady = isPending && item.selectedLanguage !== '';
  const isProcessing = item.status === 'uploading' || item.status === 'processing';

  return (
    <Card className={cn(
      'transition-colors',
      item.status === 'error' && 'border-destructive',
      item.status === 'complete' && 'border-green-500',
    )}>
      <CardContent className="p-4">
        <div className="flex items-center gap-4">
          {/* File info */}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              <p className="font-medium truncate" title={item.file.name}>
                {item.file.name}
              </p>
              {/* Detected language badge */}
              {item.detectedLanguage && (
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Badge variant="secondary" className="shrink-0">
                      {getLanguageName(item.detectedLanguage)}
                    </Badge>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Detected from filename pattern</p>
                  </TooltipContent>
                </Tooltip>
              )}
              {/* Warning if no language selected */}
              {!item.selectedLanguage && isPending && (
                <Tooltip>
                  <TooltipTrigger asChild>
                    <AlertCircle className="h-4 w-4 text-amber-500 shrink-0" />
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Please select a language</p>
                  </TooltipContent>
                </Tooltip>
              )}
            </div>
            <p className="text-sm text-muted-foreground">
              {formatFileSize(item.file.size)}
              {item.status !== 'pending' && (
                <span className="ml-2 capitalize">
                  â€” {item.status}
                  {item.errorMessage && `: ${item.errorMessage}`}
                </span>
              )}
            </p>
          </div>

          {/* Settings (only when pending) */}
          {isPending && (
            <>
              <LanguageSelect
                value={item.selectedLanguage}
                onValueChange={(value) =>
                  onUpdateSettings(item.id, { selectedLanguage: value })
                }
              />
              <ModelSelect
                value={item.selectedModel}
                onValueChange={(value) =>
                  onUpdateSettings(item.id, { selectedModel: value })
                }
              />
            </>
          )}

          {/* Actions */}
          <div className="flex items-center gap-2">
            {/* Start button (per-file) */}
            {onStart && isPending && (
              <Button
                variant="outline"
                size="sm"
                onClick={() => onStart(item.id)}
                disabled={!isReady}
                title={isReady ? 'Start processing' : 'Select language first'}
              >
                <Play className="h-4 w-4" />
              </Button>
            )}

            {/* Remove button (only when pending) */}
            {isPending && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onRemove(item.id)}
                className="text-muted-foreground hover:text-destructive"
              >
                <X className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

Create frontend/src/components/upload/FileQueueList.tsx:

```typescript
import { Trash2, Play } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { FileQueueItem } from './FileQueueItem';
import type { FileQueueItem as FileQueueItemType, LanguageCode, WhisperModel } from '@/types/upload';

interface FileQueueListProps {
  queue: FileQueueItemType[];
  onRemoveFile: (id: string) => void;
  onUpdateSettings: (
    id: string,
    updates: { selectedLanguage?: LanguageCode | ''; selectedModel?: WhisperModel }
  ) => void;
  onClearPending: () => void;
  onStartAll?: () => void;
  onStartFile?: (id: string) => void;
  pendingCount: number;
  readyCount: number;
}

/**
 * File queue list with batch actions
 *
 * Features:
 * - Scrollable list of queue items
 * - "Clear queue" button to remove all pending
 * - "Start all" button to begin processing ready files
 * - Per CONTEXT.md: FIFO order, sequential processing
 */
export function FileQueueList({
  queue,
  onRemoveFile,
  onUpdateSettings,
  onClearPending,
  onStartAll,
  onStartFile,
  pendingCount,
  readyCount,
}: FileQueueListProps) {
  if (queue.length === 0) {
    return null;
  }

  return (
    <div className="space-y-4">
      {/* Header with counts and actions */}
      <div className="flex items-center justify-between">
        <div className="text-sm text-muted-foreground">
          {pendingCount} file{pendingCount !== 1 ? 's' : ''} in queue
          {readyCount > 0 && readyCount < pendingCount && (
            <span className="ml-1">
              ({readyCount} ready)
            </span>
          )}
        </div>
        <div className="flex items-center gap-2">
          {/* Clear queue button */}
          {pendingCount > 0 && (
            <Button
              variant="outline"
              size="sm"
              onClick={onClearPending}
            >
              <Trash2 className="mr-2 h-4 w-4" />
              Clear queue
            </Button>
          )}
          {/* Start all button */}
          {onStartAll && readyCount > 0 && (
            <Button
              size="sm"
              onClick={onStartAll}
            >
              <Play className="mr-2 h-4 w-4" />
              Start all ({readyCount})
            </Button>
          )}
        </div>
      </div>

      {/* Queue items */}
      <ScrollArea className="max-h-[60vh]">
        <div className="space-y-2 pr-4">
          {queue.map(item => (
            <FileQueueItem
              key={item.id}
              item={item}
              onRemove={onRemoveFile}
              onUpdateSettings={onUpdateSettings}
              onStart={onStartFile}
            />
          ))}
        </div>
      </ScrollArea>
    </div>
  );
}
```
  </action>
  <verify>
    - `cat frontend/src/components/upload/FileQueueItem.tsx` shows item component
    - `cat frontend/src/components/upload/FileQueueList.tsx` shows list component
    - `grep "LanguageSelect" frontend/src/components/upload/FileQueueItem.tsx` confirms import
    - `grep "Badge" frontend/src/components/upload/FileQueueItem.tsx` confirms badge for detection
  </verify>
  <done>
    - FileQueueItem displays file info, detected language badge, settings dropdowns, actions
    - FileQueueList renders scrollable list with batch actions
    - Remove button only shown for pending files
    - Start buttons disabled until language selected
    - Detected language shows tooltip explaining detection
  </done>
</task>

<task type="auto">
  <name>Task 3: Assemble upload page in App.tsx</name>
  <files>
    frontend/src/App.tsx
  </files>
  <action>
Update frontend/src/App.tsx to wire everything together:

```typescript
import { UploadDropzone } from '@/components/upload/UploadDropzone';
import { FileQueueList } from '@/components/upload/FileQueueList';
import { useFileQueue } from '@/hooks/useFileQueue';

/**
 * Main upload page
 *
 * Integrates:
 * - UploadDropzone for drag-drop and file selection
 * - FileQueueList for queue display and management
 * - useFileQueue for state management
 *
 * Note: Start functionality is stubbed (Phase 5 will add actual upload)
 */
function App() {
  const {
    queue,
    addFiles,
    removeFile,
    clearPendingFiles,
    updateFileSettings,
    pendingCount,
    readyCount,
  } = useFileQueue();

  // Stub for start functionality (implemented in Phase 5)
  const handleStartAll = () => {
    console.log('Start all clicked - will be implemented in Phase 5');
  };

  const handleStartFile = (id: string) => {
    console.log(`Start file ${id} clicked - will be implemented in Phase 5`);
  };

  return (
    <UploadDropzone onFilesAdded={addFiles}>
      <FileQueueList
        queue={queue}
        onRemoveFile={removeFile}
        onUpdateSettings={updateFileSettings}
        onClearPending={clearPendingFiles}
        onStartAll={handleStartAll}
        onStartFile={handleStartFile}
        pendingCount={pendingCount}
        readyCount={readyCount}
      />
    </UploadDropzone>
  );
}

export default App;
```

This completes the upload page assembly. The "Start" functionality is stubbed as it requires Phase 5's upload integration.
  </action>
  <verify>
    - `cat frontend/src/App.tsx` shows complete page assembly
    - `grep "useFileQueue" frontend/src/App.tsx` confirms hook usage
    - `grep "UploadDropzone" frontend/src/App.tsx` confirms dropzone
    - `grep "FileQueueList" frontend/src/App.tsx` confirms queue list
    - `cd frontend && bun run build` succeeds
  </verify>
  <done>
    - App.tsx renders UploadDropzone with FileQueueList
    - useFileQueue manages all queue state
    - Start handlers stubbed for Phase 5 implementation
    - Build succeeds without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete upload UI with:
- Full-page drag-and-drop zone
- File picker button
- File queue display with per-file settings
- Language auto-detection with badge
- Language and model selection dropdowns
- Remove file and clear queue actions
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd frontend && bun run dev`
2. Open http://localhost:5173/ui/ in browser

Test drag-and-drop:
3. Drag an audio file (e.g., test_A03_interview.mp3) onto the page
4. Verify: Light overlay appears saying "Drop files here"
5. Drop the file
6. Verify: File appears in queue with "Latvian" badge (A03 detected)

Test file picker:
7. Click "Select files" button
8. Select multiple audio/video files
9. Verify: All files added to queue

Test rejection:
10. Drag a .txt or .pdf file onto the page and drop
11. Verify: Toast notification shows "Invalid files rejected"

Test settings:
12. Click language dropdown - verify Primary group (Latvian, Russian, English) at top
13. Change language selection
14. Click model dropdown - verify all 6 model options shown
15. Verify: Default model is "Large v3"

Test queue management:
16. Click X on a file - verify it's removed
17. Click "Clear queue" - verify all pending files removed
18. Verify: "Start all" button shows count of ready files
19. Verify: "Start all" and per-file play buttons disabled until language selected

Expected outcome:
- Drag-drop works anywhere on page
- File picker works via button
- Invalid files show toast and don't appear in queue
- Language detection works (A03/A04/A05 patterns)
- All dropdowns functional
- Queue management works
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All component files exist in frontend/src/components/upload/
2. App.tsx properly imports and renders all components
3. Build succeeds: `cd frontend && bun run build`
4. Dev server runs: `cd frontend && bun run dev`
5. Manual testing confirms all requirements met
</verification>

<success_criteria>
- User can drag-and-drop audio/video files onto upload zone (UPLD-01)
- User can select files via file picker dialog (UPLD-02)
- User can upload multiple files and see queue display (UPLD-03)
- System auto-detects language from filename pattern A03/A04/A05 (UPLD-05)
- User can select transcription language from dropdown with core 3 pinned (LANG-01)
- User can select Whisper model size with large-v3 default (LANG-02)
- Invalid files rejected with toast notification
- Queue management (remove, clear) works correctly
- Start buttons disabled until language selected
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-upload-flow/04-04-SUMMARY.md`
</output>
