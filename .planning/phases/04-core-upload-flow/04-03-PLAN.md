---
phase: 04-core-upload-flow
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - frontend/src/hooks/useFileQueue.ts
  - frontend/src/components/upload/UploadDropzone.tsx
autonomous: true

must_haves:
  truths:
    - "useFileQueue hook manages file queue state correctly"
    - "Files can be added to queue via drag-and-drop"
    - "Files can be added via file picker button"
    - "Invalid file types show toast notification and are rejected"
    - "Drag overlay appears when dragging files over page"
  artifacts:
    - path: "frontend/src/hooks/useFileQueue.ts"
      provides: "File queue state management hook"
      exports: ["useFileQueue"]
      min_lines: 50
    - path: "frontend/src/components/upload/UploadDropzone.tsx"
      provides: "Full-page drop target with select button"
      exports: ["UploadDropzone"]
      min_lines: 60
  key_links:
    - from: "frontend/src/components/upload/UploadDropzone.tsx"
      to: "react-dropzone"
      via: "useDropzone hook"
      pattern: "useDropzone"
    - from: "frontend/src/hooks/useFileQueue.ts"
      to: "frontend/src/lib/languageDetection.ts"
      via: "detectLanguageFromFilename import"
      pattern: "detectLanguageFromFilename"
    - from: "frontend/src/components/upload/UploadDropzone.tsx"
      to: "sonner"
      via: "toast for rejection notifications"
      pattern: "toast\\.error"
---

<objective>
Create the file queue state management hook and the full-page drag-and-drop upload zone component.

Purpose: useFileQueue provides centralized state for the file queue with add/remove/update operations. UploadDropzone implements the full-page drop target pattern from RESEARCH.md, handling file validation and rejection feedback.
Output: Working file queue hook and dropzone component that accepts audio/video files.
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-upload-flow/04-CONTEXT.md
@.planning/phases/04-core-upload-flow/04-RESEARCH.md
@frontend/src/types/upload.ts
@frontend/src/lib/languageDetection.ts
@frontend/src/lib/whisperModels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFileQueue hook</name>
  <files>
    frontend/src/hooks/useFileQueue.ts
  </files>
  <action>
Create frontend/src/hooks/useFileQueue.ts with queue state management:

```typescript
import { useState, useCallback } from 'react';
import type { FileQueueItem, WhisperModel, LanguageCode } from '@/types/upload';
import { detectLanguageFromFilename } from '@/lib/languageDetection';
import { DEFAULT_MODEL } from '@/lib/whisperModels';

/**
 * Hook for managing the file upload queue
 *
 * Handles:
 * - Adding files with auto-detected language and default model
 * - Removing individual files (only when pending)
 * - Clearing all pending files
 * - Updating file settings (language, model)
 * - Getting files ready to process (language selected)
 */
export function useFileQueue() {
  const [queue, setQueue] = useState<FileQueueItem[]>([]);

  /**
   * Add files to the queue with detected language and default model
   */
  const addFiles = useCallback((files: File[]) => {
    const newItems: FileQueueItem[] = files.map(file => {
      const detectedLanguage = detectLanguageFromFilename(file.name);
      return {
        id: crypto.randomUUID(),
        file,
        detectedLanguage,
        // Pre-fill selectedLanguage if detected, empty string otherwise
        selectedLanguage: detectedLanguage ?? '',
        selectedModel: DEFAULT_MODEL,
        status: 'pending',
      };
    });

    setQueue(previousQueue => [...previousQueue, ...newItems]);
  }, []);

  /**
   * Remove a file from the queue (only if pending)
   * Per CONTEXT.md: "Files can only be removed before processing starts"
   */
  const removeFile = useCallback((id: string) => {
    setQueue(previousQueue =>
      previousQueue.filter(item => item.id !== id || item.status !== 'pending')
    );
  }, []);

  /**
   * Clear all pending files from the queue
   * Keeps files that are currently processing or completed
   */
  const clearPendingFiles = useCallback(() => {
    setQueue(previousQueue =>
      previousQueue.filter(item => item.status !== 'pending')
    );
  }, []);

  /**
   * Update settings for a specific file
   */
  const updateFileSettings = useCallback((
    id: string,
    updates: Partial<Pick<FileQueueItem, 'selectedLanguage' | 'selectedModel'>>
  ) => {
    setQueue(previousQueue =>
      previousQueue.map(item =>
        item.id === id ? { ...item, ...updates } : item
      )
    );
  }, []);

  /**
   * Update file status (for upload/processing flow)
   */
  const updateFileStatus = useCallback((
    id: string,
    status: FileQueueItem['status'],
    errorMessage?: string
  ) => {
    setQueue(previousQueue =>
      previousQueue.map(item =>
        item.id === id ? { ...item, status, errorMessage } : item
      )
    );
  }, []);

  /**
   * Check if a file is ready to process (has language selected)
   */
  const isFileReady = useCallback((item: FileQueueItem): boolean => {
    return item.status === 'pending' && item.selectedLanguage !== '';
  }, []);

  /**
   * Get count of pending files
   */
  const pendingCount = queue.filter(item => item.status === 'pending').length;

  /**
   * Get count of files ready to process
   */
  const readyCount = queue.filter(isFileReady).length;

  /**
   * Check if any files are currently processing
   */
  const hasProcessingFiles = queue.some(
    item => item.status === 'uploading' || item.status === 'processing'
  );

  return {
    queue,
    addFiles,
    removeFile,
    clearPendingFiles,
    updateFileSettings,
    updateFileStatus,
    isFileReady,
    pendingCount,
    readyCount,
    hasProcessingFiles,
  };
}

export type UseFileQueueReturn = ReturnType<typeof useFileQueue>;
```

Key decisions:
- detectLanguageFromFilename called on file add (auto-detection)
- DEFAULT_MODEL used for all new files (large-v3 per user preference)
- removeFile only removes pending files (per CONTEXT.md decision)
- isFileReady checks for language selection (required before processing)
  </action>
  <verify>
    - `cat frontend/src/hooks/useFileQueue.ts` shows hook implementation
    - `grep "detectLanguageFromFilename" frontend/src/hooks/useFileQueue.ts` shows import
    - `grep "DEFAULT_MODEL" frontend/src/hooks/useFileQueue.ts` shows usage
  </verify>
  <done>
    - useFileQueue hook exists with all CRUD operations
    - Auto-detects language on file add
    - Uses large-v3 as default model
    - removeFile respects "only pending" constraint
    - Exports UseFileQueueReturn type
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UploadDropzone component</name>
  <files>
    frontend/src/components/upload/UploadDropzone.tsx
  </files>
  <action>
Create directory and component:

```bash
mkdir -p frontend/src/components/upload
```

Create frontend/src/components/upload/UploadDropzone.tsx:

```typescript
import { useDropzone } from 'react-dropzone';
import { toast } from 'sonner';
import { Upload } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';

interface UploadDropzoneProps {
  onFilesAdded: (files: File[]) => void;
  children: React.ReactNode;
  className?: string;
}

/**
 * Full-page drop target for audio/video file uploads
 *
 * Features:
 * - Accepts audio/* and video/* files with common extensions
 * - Shows overlay when dragging files over page
 * - Always-visible "Select files" button
 * - Toast notification for rejected files
 *
 * Pattern: noClick=true so clicking anywhere doesn't open picker
 * (button.onClick calls open() explicitly)
 */
export function UploadDropzone({
  onFilesAdded,
  children,
  className,
}: UploadDropzoneProps) {
  const {
    getRootProps,
    getInputProps,
    open,
    isDragActive,
  } = useDropzone({
    // Don't open file dialog on click - use button instead
    noClick: true,
    // Don't open on keyboard (we have explicit button)
    noKeyboard: true,
    // Accept audio and video files
    // Using both MIME wildcards AND extensions per RESEARCH.md Pitfall #1
    accept: {
      'audio/*': ['.mp3', '.wav', '.ogg', '.m4a', '.flac', '.aac', '.wma'],
      'video/*': ['.mp4', '.webm', '.mov', '.avi', '.mkv', '.m4v', '.wmv'],
    },
    onDrop: (acceptedFiles, fileRejections) => {
      // Handle rejected files with toast (RESEARCH.md Pitfall #2)
      if (fileRejections.length > 0) {
        const rejectedNames = fileRejections
          .map(rejection => rejection.file.name)
          .slice(0, 3);
        const moreCount = fileRejections.length > 3
          ? ` and ${fileRejections.length - 3} more`
          : '';

        toast.error('Invalid files rejected', {
          description: `${rejectedNames.join(', ')}${moreCount} â€” Only audio/video files are allowed`,
        });
      }

      // Add accepted files to queue
      if (acceptedFiles.length > 0) {
        onFilesAdded(acceptedFiles);
      }
    },
  });

  return (
    <div
      {...getRootProps()}
      className={cn('min-h-screen relative', className)}
    >
      <input {...getInputProps()} />

      {/* Drag overlay - shows when files are being dragged over */}
      {isDragActive && (
        <div className="fixed inset-0 bg-primary/10 backdrop-blur-sm z-50 flex flex-col items-center justify-center gap-4 pointer-events-none">
          <Upload className="h-16 w-16 text-primary animate-pulse" />
          <p className="text-2xl font-medium text-primary">
            Drop files here
          </p>
          <p className="text-muted-foreground">
            Audio and video files only
          </p>
        </div>
      )}

      {/* Page content with select button */}
      <div className="container mx-auto px-4 py-8">
        {/* Header with select button */}
        <div className="flex items-center justify-between mb-8">
          <h1 className="text-3xl font-bold">Upload Files</h1>
          <Button onClick={open} size="lg">
            <Upload className="mr-2 h-5 w-5" />
            Select files
          </Button>
        </div>

        {/* Children (queue list, etc.) */}
        {children}

        {/* Empty state hint */}
        {!children && (
          <div className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-12 text-center">
            <Upload className="mx-auto h-12 w-12 text-muted-foreground/50 mb-4" />
            <p className="text-lg text-muted-foreground mb-2">
              Drag and drop audio or video files here
            </p>
            <p className="text-sm text-muted-foreground/75">
              or click "Select files" above
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
```

Key implementation details:
- noClick: true prevents entire page from being clickable (RESEARCH.md Pattern #1)
- accept uses both MIME wildcards AND extensions (RESEARCH.md Pitfall #1)
- fileRejections handled with toast (RESEARCH.md Pitfall #2)
- Overlay uses fixed positioning and pointer-events-none
- Button uses open() function from useDropzone
  </action>
  <verify>
    - `cat frontend/src/components/upload/UploadDropzone.tsx` shows component
    - `grep "noClick: true" frontend/src/components/upload/UploadDropzone.tsx` confirms pattern
    - `grep "toast.error" frontend/src/components/upload/UploadDropzone.tsx` confirms rejection handling
    - `grep "isDragActive" frontend/src/components/upload/UploadDropzone.tsx` confirms overlay
  </verify>
  <done>
    - UploadDropzone component exists with full-page drop target
    - Uses noClick: true pattern with explicit button
    - Handles file rejections with toast notification
    - Shows drag overlay when isDragActive
    - Accepts onFilesAdded callback and children props
  </done>
</task>

</tasks>

<verification>
1. Verify directories exist: `ls frontend/src/hooks frontend/src/components/upload`
2. TypeScript check: `cd frontend && bun run build` should succeed
3. All imports resolve correctly (types, lib, components/ui)
4. No circular dependencies
</verification>

<success_criteria>
- useFileQueue hook manages queue state with add/remove/update/clear operations
- UploadDropzone accepts drops anywhere on page
- File picker opens via button click (not page click)
- Invalid files trigger toast notification
- Drag overlay appears during file drag
- Both components properly typed with TypeScript
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-upload-flow/04-03-SUMMARY.md`
</output>
