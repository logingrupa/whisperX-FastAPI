---
phase: 06-transcript-viewer-export
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - frontend/src/components/upload/FileQueueItem.tsx
  - frontend/src/hooks/useUploadOrchestration.ts
autonomous: false

must_haves:
  truths:
    - "Completed files show 'View Transcript' button"
    - "Clicking View Transcript expands to show TranscriptViewer"
    - "Download buttons appear for completed files"
    - "Transcript data is fetched when user expands viewer"
  artifacts:
    - path: "frontend/src/components/upload/FileQueueItem.tsx"
      provides: "Integrated transcript viewer in queue item"
      contains: "TranscriptViewer"
  key_links:
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/components/transcript/TranscriptViewer.tsx"
      via: "component import"
      pattern: "import.*TranscriptViewer.*from.*transcript"
    - from: "frontend/src/components/upload/FileQueueItem.tsx"
      to: "frontend/src/lib/api/taskApi.ts"
      via: "fetch on expand"
      pattern: "fetchTaskResult"
---

<objective>
Integrate transcript viewer into completed file queue items

Purpose: Wire the transcript viewing and download functionality into the existing upload flow, allowing users to view and export transcripts directly from completed queue items

Output: FileQueueItem shows expandable transcript viewer with download options for completed files
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-transcript-viewer-export/06-RESEARCH.md
@.planning/phases/06-transcript-viewer-export/06-01-SUMMARY.md
@.planning/phases/06-transcript-viewer-export/06-02-SUMMARY.md
@.planning/phases/06-transcript-viewer-export/06-03-SUMMARY.md

# Files to modify
@frontend/src/components/upload/FileQueueItem.tsx
@frontend/src/hooks/useUploadOrchestration.ts

# Components to integrate
@frontend/src/components/transcript/TranscriptViewer.tsx
@frontend/src/components/transcript/DownloadButtons.tsx
@frontend/src/components/ui/collapsible.tsx
@frontend/src/lib/api/taskApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update FileQueueItem with transcript integration</name>
  <files>frontend/src/components/upload/FileQueueItem.tsx</files>
  <action>
Update `frontend/src/components/upload/FileQueueItem.tsx` to add transcript viewing for completed files:

1. Add new imports at top:
```typescript
import { useState } from 'react';
import { ChevronDown, ChevronUp } from 'lucide-react';
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from '@/components/ui/collapsible';
import { TranscriptViewer } from '@/components/transcript/TranscriptViewer';
import { DownloadButtons } from '@/components/transcript/DownloadButtons';
import { fetchTaskResult } from '@/lib/api/taskApi';
import type { TranscriptSegment, TaskMetadata } from '@/types/transcript';
```

2. Add new props to interface:
```typescript
interface FileQueueItemProps {
  // ... existing props ...
  // No new props needed - uses item.taskId for fetching
}
```

3. Add state for transcript data inside component:
```typescript
const [isTranscriptOpen, setIsTranscriptOpen] = useState(false);
const [transcriptSegments, setTranscriptSegments] = useState<TranscriptSegment[] | null>(null);
const [transcriptMetadata, setTranscriptMetadata] = useState<TaskMetadata | null>(null);
const [isLoadingTranscript, setIsLoadingTranscript] = useState(false);
const [transcriptError, setTranscriptError] = useState<string | null>(null);
```

4. Add fetch handler:
```typescript
const handleToggleTranscript = async () => {
  // If opening and no data yet, fetch it
  if (!isTranscriptOpen && !transcriptSegments && item.taskId) {
    setIsLoadingTranscript(true);
    setTranscriptError(null);

    const result = await fetchTaskResult(item.taskId);

    if (result.success && result.data.result?.segments) {
      setTranscriptSegments(result.data.result.segments);
      setTranscriptMetadata({
        file_name: result.data.file_name,
        language: result.data.language,
        audio_duration: result.data.audio_duration,
      });
    } else {
      setTranscriptError(
        result.success
          ? 'No transcript data available'
          : result.error.detail
      );
    }

    setIsLoadingTranscript(false);
  }

  setIsTranscriptOpen(!isTranscriptOpen);
};
```

5. Add collapsible transcript section AFTER the progress bar row (inside the main flex-col div, only for isComplete):
```typescript
{/* Transcript viewer (completed files only) */}
{isComplete && item.taskId && (
  <Collapsible open={isTranscriptOpen} onOpenChange={setIsTranscriptOpen}>
    <div className="flex items-center justify-between pt-2 border-t border-border">
      <CollapsibleTrigger asChild>
        <Button
          variant="ghost"
          size="sm"
          onClick={handleToggleTranscript}
          className="gap-1"
        >
          {isTranscriptOpen ? (
            <ChevronUp className="h-4 w-4" />
          ) : (
            <ChevronDown className="h-4 w-4" />
          )}
          {isLoadingTranscript ? 'Loading...' : 'View Transcript'}
        </Button>
      </CollapsibleTrigger>

      {/* Download buttons (always visible for complete) */}
      {transcriptSegments && (
        <DownloadButtons
          segments={transcriptSegments}
          filename={item.file.name.replace(/\.[^/.]+$/, '')}
          metadata={transcriptMetadata ?? undefined}
        />
      )}
    </div>

    <CollapsibleContent>
      <div className="pt-3">
        {isLoadingTranscript && (
          <div className="text-center py-4 text-muted-foreground">
            Loading transcript...
          </div>
        )}

        {transcriptError && (
          <div className="text-center py-4 text-destructive">
            {transcriptError}
          </div>
        )}

        {transcriptSegments && !isLoadingTranscript && (
          <TranscriptViewer segments={transcriptSegments} maxHeight="250px" />
        )}
      </div>
    </CollapsibleContent>
  </Collapsible>
)}
```

IMPORTANT NOTES:
- Fetch happens on first expand only (lazy loading)
- Download buttons appear in the header row once data is loaded (always accessible)
- Filename for downloads uses original file name without extension
- Transcript only shown for completed files with a taskId
  </action>
  <verify>TypeScript compiles: `cd frontend && bunx tsc --noEmit`</verify>
  <done>FileQueueItem shows expandable transcript viewer for completed files</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete transcript viewing and export flow:
- Completed files show "View Transcript" button
- Clicking expands to show transcript with timestamps and speaker labels
- Download buttons (SRT, VTT, TXT, JSON) appear when transcript is loaded
- Downloads generate proper file formats with correct encoding
  </what-built>
  <how-to-verify>
1. Start the development servers:
   ```bash
   # Terminal 1: Backend
   cd C:\laragon\www\whisperx
   uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

   # Terminal 2: Frontend
   cd C:\laragon\www\whisperx\frontend
   bun run dev
   ```

2. Open http://localhost:5173 in browser

3. Upload a small audio file and process it:
   - Drag or click to upload an audio file
   - Select a language
   - Click Start

4. Wait for transcription to complete (shows green checkmark)

5. Verify transcript viewing:
   - [ ] "View Transcript" button appears on completed file
   - [ ] Clicking it expands to show transcript
   - [ ] Timestamps are displayed in MM:SS or HH:MM:SS format
   - [ ] Speaker labels show as "Speaker 1", "Speaker 2", etc. (if diarization was enabled)
   - [ ] Text content is displayed correctly

6. Verify downloads:
   - [ ] Download buttons appear (SRT, VTT, TXT, JSON)
   - [ ] Click SRT - file downloads with .srt extension
   - [ ] Open SRT file - timestamps use comma separator (00:00:01,500)
   - [ ] Click VTT - file downloads with .vtt extension
   - [ ] Open VTT file - starts with "WEBVTT" header, timestamps use period
   - [ ] Click TXT - plain text downloads correctly
   - [ ] Click JSON - JSON with full metadata downloads

7. Verify Unicode handling (if testing with Latvian/Russian audio):
   - [ ] Downloaded files show correct characters (not ???)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 6, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `cd frontend && bunx tsc --noEmit` - TypeScript compiles without errors
2. `cd frontend && bun run build` - Production build succeeds
3. Human verification of complete flow
</verification>

<success_criteria>
- VIEW-01: User can view transcript with paragraph-level timestamps
- VIEW-02: User can see speaker labels (Speaker 1, Speaker 2, etc.)
- DOWN-01: User can download transcript as SRT file
- DOWN-02: User can download transcript as VTT file
- DOWN-03: User can download transcript as plain text file
- DOWN-04: User can download transcript as JSON with full metadata
</success_criteria>

<output>
After completion, create `.planning/phases/06-transcript-viewer-export/06-04-SUMMARY.md`
</output>
