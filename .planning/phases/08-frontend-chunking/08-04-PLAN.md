---
phase: 08-frontend-chunking
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/upload_session_service.py
  - .venv/Lib/site-packages/tuspyserver/file.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Large file TUS upload completes and triggers transcription without 422 error"
    - "Backend startup gc_files cleanup runs without date parsing errors"
  artifacts:
    - path: "app/services/upload_session_service.py"
      provides: "File rename with original extension before process_audio_file call"
      contains: "shutil.move"
    - path: ".venv/Lib/site-packages/tuspyserver/file.py"
      provides: "RFC 7231 date parsing in gc_files"
      contains: "parsedate_to_datetime"
  key_links:
    - from: "app/services/upload_session_service.py"
      to: "app/audio.py:process_audio_file"
      via: "renamed file path with extension"
      pattern: "process_audio_file.*\\.(mp3|wav|m4a|mp4|flac|ogg|webm)"
    - from: ".venv/Lib/site-packages/tuspyserver/file.py"
      to: "app/infrastructure/scheduler/cleanup_scheduler.py"
      via: "gc_files parses expires dates correctly"
      pattern: "parsedate_to_datetime"
---

<objective>
Fix two TUS integration bugs discovered during UAT that block the upload-to-transcription pipeline.

Purpose: Tests 2, 4, and 5 all fail due to these two root causes. Fixing them unblocks the entire TUS upload flow.
Output: Patched upload_session_service.py and tuspyserver/file.py so TUS uploads complete end-to-end and cleanup runs cleanly.
</objective>

<execution_context>
@C:\Users\rolan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rolan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-frontend-chunking/08-UAT.md
@app/services/upload_session_service.py
@app/audio.py
@app/files.py
@.venv/Lib/site-packages/tuspyserver/file.py
@app/infrastructure/scheduler/cleanup_scheduler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename TUS file with original extension before transcription</name>
  <files>app/services/upload_session_service.py</files>
  <action>
In `start_transcription()`, between the magic bytes validation (line 80) and the `process_audio_file()` call (line 83), add file renaming logic:

1. Add `import shutil` at the top of the file.
2. After the magic bytes validation succeeds (after line 80), add these lines:
   - Build the renamed path: `renamed_path = str(Path(file_path).parent / (Path(file_path).name + extension))`
   - Rename the file: `shutil.move(file_path, renamed_path)`
   - Log the rename: `logger.info("Renamed TUS file: %s -> %s", file_path, renamed_path)`
   - Update the variable: `file_path = renamed_path`
3. The existing `process_audio_file(file_path)` call on line 83 will now receive the path WITH extension.

Why this works: TUS stores assembled files as hash IDs (e.g., `a1b2c3d4...`) with no extension. The code already extracts `extension` from metadata on line 77 (`Path(filename).suffix`) but never uses it to rename the file. `check_file_extension()` inside `process_audio_file()` rejects empty extensions, causing the 422.

Do NOT change the metadata extraction logic (lines 76-77) — it already works correctly.
Do NOT change how process_audio_file is called — just ensure it receives a path with extension.
  </action>
  <verify>
Read the modified file and confirm:
1. `shutil` is imported
2. Between magic bytes validation and `process_audio_file()`, the file is renamed with extension
3. `process_audio_file()` receives the renamed path
  </verify>
  <done>TUS assembled file is renamed with its original extension (from metadata) before being passed to process_audio_file, preventing the 422 UnsupportedFileExtensionError.</done>
</task>

<task type="auto">
  <name>Task 2: Patch tuspyserver gc_files date parsing for RFC 7231 format</name>
  <files>.venv/Lib/site-packages/tuspyserver/file.py</files>
  <action>
Patch `gc_files()` in tuspyserver/file.py to parse RFC 7231 dates correctly. This follows the same precedent as the lock.py replacement done in Phase 07-01.

1. Add `from email.utils import parsedate_to_datetime` to the imports at the top of the file (after the existing `import datetime`).
2. In the `gc_files()` function (line 120-130), replace line 127:
   - Old: `and datetime.datetime.fromisoformat(file.info.expires)`
   - New: `and parsedate_to_datetime(file.info.expires)`

Why `parsedate_to_datetime`: tuspyserver's `creation.py` writes expires dates using `email.utils.formatdate()` which produces RFC 7231 format like "Fri, 30 Jan 2026 18:16:01 GMT". But `gc_files` reads them with `fromisoformat()` which only accepts ISO 8601. The library's own `core.py` already uses `parsedate_to_datetime` for the same purpose in `_check_upload_expired`.

Also replace `datetime.datetime.now()` on line 128 with `datetime.datetime.now(tz=datetime.timezone.utc)` for correct timezone-aware comparison (parsedate_to_datetime returns timezone-aware datetimes).

Do NOT modify any other function in file.py.
Do NOT touch TusUploadFile class or list_files function.
  </action>
  <verify>
Read the patched file and confirm:
1. `from email.utils import parsedate_to_datetime` is in imports
2. `gc_files()` uses `parsedate_to_datetime(file.info.expires)` instead of `fromisoformat`
3. Comparison uses timezone-aware `datetime.datetime.now(tz=datetime.timezone.utc)`
  </verify>
  <done>gc_files correctly parses RFC 7231 expires dates, eliminating the ValueError on startup cleanup.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read `app/services/upload_session_service.py` — confirm rename logic between validation and process_audio_file
2. Read `.venv/Lib/site-packages/tuspyserver/file.py` — confirm parsedate_to_datetime in gc_files
3. Run `python -c "from app.services.upload_session_service import UploadSessionService; print('import ok')"` to verify no syntax errors
4. Run `python -c "from tuspyserver.file import gc_files; print('gc_files import ok')"` to verify no syntax errors
</verification>

<success_criteria>
- TUS assembled files are renamed with their original extension before transcription (fixes Tests 2 and 4)
- gc_files parses RFC 7231 date strings without ValueError (fixes Test 5)
- No import errors in either modified file
</success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-chunking/08-04-SUMMARY.md`
</output>
